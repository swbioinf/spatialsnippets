---
title: "Differential celltype composition between groups"
author: "Sarah Williams"
output:
  html_notebook: 
    toc: yes
    code_folding: hide
  html_document:
    toc: yes
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r angrylibrarian, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(echo = TRUE)
```

Is there a difference in the celltype composition between individuals with  Ulcerative colitis  or Crohn's disease, and Healthy controls?


# Load libraries and data object

```{r}
library(Seurat)
library(speckle)
library(tidyverse)
library(DT)
```

```{r}
data_dir              <- file.path("~/projects/spatialsnippets/datasets/GSE234713_IBDcosmx_GarridoTrigo2023/processed_data") 
seurat_file_01_loaded <- file.path(data_dir, "GSE234713_CosMx_IBD_seurat_01_loaded.RDS")
```


```{r}
so <- readRDS(seurat_file_01_loaded)
```

# Looking at the data

<!-- Move this to own page? --->

There are three individuals per condition (one tissue sample from each individual). With multiple fovs on each physical tissue sample.
```{r}
sample_table <- select(as_tibble(so@meta.data), condition, individual_code, fov_name) %>%
  unique() %>% 
  group_by(condition, individual_code) %>% 
  summarise(n_fovs= n(), item = str_c(fov_name, collapse = ", "))

DT::datatable(sample_table)
```








# Full worked example 

## Count how many cells of each type in your data

In this dataset there are two different levels of categorisation. We'd like to look at the celltype proportions at a more granular resolution - but we need to ensure there are enough cells of each type for meaningful statistics. 

* Celltype_subset; Some broad groupings of cell types.
* celltype_SingleR2: Much more specific groupings, predicted with the singleR method.


In the 'Celltype_subset' column, there are 5 broad categories;
```{r}
celltype_summary_table <- so@meta.data %>% 
  group_by(condition, individual_code, fov_name, celltype_subset) %>%
  summarise(cells=n(), .groups = 'drop')
DT::datatable(celltype_summary_table)
```

Here T cells are rare, but there are still a decent distribution of them with 10-100+ cells in a FOV. We should be able to see changes in these.

```{r}
ggplot(celltype_summary_table, aes(x=cells, col=celltype_subset)) +
  geom_density() +
  geom_rug(alpha=0.2) +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Cells per FOV by celltype")
```


On the other hand, could we use the more fine-grained categoriesation in the 'celltype_SingleR2' grouping?

There are many different types here - which is typical if you're using celltype assignment with a detailed reference. 

In this case, there are just too many cell type categories, and we should stick with the broad categorisation.

Approaches to handle this when you want to keep the specific types:

* Drop 'nonsense' cell types: When cell typing with a broad refernece, you might get a handful of irrelevant cell types called (e.g. 4 hepatocytes on a non-liver sample).
* Pool subtypes: Some celltypes are simply rare. Rather then dropping them entirely, you can pool transcriptionally similar cells (e.g. T cell subtypes).

The more cell types you have, the more agressive your FDR multiple hypothesis correction will need to be. Its best to remove cell types that can never reach statistical significance. 


```{r}
celltype_summary_table.SingleR <- so@meta.data %>% 
  group_by(condition, individual_code, fov_name, celltype_SingleR2) %>%
  summarise(cells=n(), .groups = 'drop')
DT::datatable(celltype_summary_table.SingleR)
```


```{r}
ggplot(celltype_summary_table.SingleR, aes(x=cells, col=celltype_SingleR2)) +
  geom_density() +
  geom_rug(alpha=0.2) +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Cells per FOV by celltype")
```


## Look at your samples. 

(add spekcle example)

```{r}
ggplot(celltype_summary_table, aes(x=fov_name, y=cells, fill=celltype_subset)) +
  geom_bar(position="fill", stat="identity") + 
  theme_bw() +
  coord_flip() + 
  theme(legend.position = "bottom") +
  facet_wrap(~condition, ncol=3, scales = 'free_y') +
  scale_y_continuous(expand = c(0,0)) 
```


## Calculate stats.


```{r}
results.anova <- propeller(clusters= so$celltype_subset, 
          sample  = so$individual_code, 
          group   = so$condition)
results.anova

# If a column is preferred over rownames
results.anova.table <- rownames_to_column( results.anova, var="celltype_subset")
```


```{r}
so.UCvsHC <- so[,so$condition %in% c("Healthy controls", "Ulcerative colitis")]


results.pair <- propeller( clusters= so.UCvsHC$celltype_subset, 
                           sample  = so.UCvsHC$individual_code, 
                           group   = so.UCvsHC$condition)
```

# Code snippet


```{r eval=FALSE}
library(speckle)
# seurat object so
results_table <- propeller(clusters = so$cluster, 
                           sample   = so$sample, 
                           group    = so$condition)


```

# Results


## Paired

```{r}
results.pair
```
* **rownames** : The tested cell types
* **BaselineProp** : The overall proportion of the cell type across the dataset. (Overall, not a average of PropMean per group).
* **PropMean.X** : The proportion of cell type in each group. Here that's PropMean.Healthy.controls, PropMean.Ulcerative.colitis) 
* **PropRatio** : Ratio of proprotions of first to second group.
* **Tstatistic** : The T statistic.
* **P.Value** : P.value
* **FDR** : A multiple-hypothesis corrected p-value




## Anova

```{r}
results.anova
```

* **rownames** : The tested cell types
* **BaselineProp** : The overall proportion of the cell type across the dataset. (Overall, not a average of PropMean per group).
* **PropMean.X** : The proportion of cell type in each group. Here that's PropMean.Chrones.s.disease, PropMean.Healthy.controls, PropMean.Ulcerative.colitis) 
* **Fstatistic** : The Fstatistic calculated.  
* **P.Value** : P.value
* **FDR** : A multiple-hypothesis corrected p-value





# More information

* Speckle Vignette (https://www.bioconductor.org/packages/release/bioc/vignettes/speckle/inst/doc/speckle.html) : Comphrehensive details of how to use different tests for speckle. 
* Propeller paper: (https://academic.oup.com/bioinformatics/article/38/20/4720/6675456)





